stage('Deploy') {
    steps {
        script {
            echo "üöÄ Deploying ${env.SERVICE_NAME}..."

            // Crear red si no existe
            sh """
              docker network inspect ${NETWORK_NAME} >/dev/null 2>&1 || \
              docker network create ${NETWORK_NAME}
            """

            // Eliminar contenedor previo si existe
            sh "docker rm -f ${SERVICE_NAME} || true"

            // Ejecutar nuevo contenedor
            sh """
              docker run -d --name ${SERVICE_NAME} \
                -p ${HOST_PORT}:${CONTAINER_PORT} \
                --network ${NETWORK_NAME} \
                ${IMAGE_NAME}
            """

            // üïì Esperar hasta 90s que el servidor arranque
            echo "‚è≥ Waiting for Config Server to start..."
            sh """
              for i in {1..30}; do
                if curl -sf http://localhost:${HOST_PORT}/actuator/health >/dev/null 2>&1; then
                  echo "‚úÖ Config Server is healthy!"
                  exit 0
                fi
                echo "‚è±Ô∏è Attempt \$i - not ready yet, checking logs..."
                docker logs ${SERVICE_NAME} | tail -n 10
                sleep 3
              done
              echo "‚ùå Config Server did not become healthy in time"
              exit 1
            """
        }
    }
}
