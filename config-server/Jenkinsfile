pipeline {
  agent any

  tools {
    jdk 'java17016'
    maven 'maven399'
  }

  environment {
    // ===== Servicio / Imagen local =====
    SERVICE      = 'config-server'
    IMAGE_BASE   = "farmatodo/${SERVICE}"
    IMAGE_TAG    = "${BUILD_NUMBER}"
    IMAGE        = "${IMAGE_BASE}:${IMAGE_TAG}"

    // ===== Red local =====
    PORT         = '8888'     // puerto interno del contenedor
    HOST         = '8889'     // puerto expuesto en el host
    NET          = 'farmatodo-network'

    // ===== SonarQube =====
    SONAR_SCANNER_HOME = tool 'sonar7'

    // ===== GCP / Artifact Registry / Cloud Run =====
    GCP_PROJECT_ID = 'planar-momentum-469121-n0'
    REGION         = 'us-central1'
    REPOSITORY     = "${SERVICE}-repo"
    AR_HOST        = "${REGION}-docker.pkg.dev"
    FULL_IMAGE_NAME = "${AR_HOST}/${GCP_PROJECT_ID}/${REPOSITORY}/${SERVICE}:${IMAGE_TAG}"

    CR_SERVICE     = "${SERVICE}"
    CR_PLATFORM    = "managed"
    CR_CPU         = "1"
    CR_MEMORY      = "512Mi"
    CR_CONCURRENCY = "80"
    CR_MIN_INST    = "0"
    CR_MAX_INST    = "2"
    CR_PORT        = "${PORT}"
    CR_ALLOW_UNAUTH = "true"
  }

  options {
    timestamps()
    timeout(time: 20, unit: 'MINUTES')
  }

  stages {

    // 1) Checkout & Build
    stage('Checkout & Build') {
      steps {
        echo "üì¶ Clonando repositorio desde GitHub..."
        checkout scmGit(
          branches: [[name: '*/main']],
          extensions: [],
          userRemoteConfigs: [[
            credentialsId: 'jenkins-gcp',
            url: 'https://github.com/santgodev/farmatodo-backend.git'
          ]]
        )

        dir(env.SERVICE) {
          echo "üß± Compilando y empacando ${SERVICE}..."
          sh "mvn -q -Dstyle.color=always clean package -DskipTests=false"
        }
      }
    }

    // 2) SonarQube
    stage('SonarQube Analysis') {
      steps {
        echo "üîç Ejecutando an√°lisis de c√≥digo con SonarQube..."
        dir(env.SERVICE) {
          withCredentials([string(credentialsId: 'sonartoken', variable: 'SONAR_TOKEN')]) {
            withSonarQubeEnv('sonar') {
              sh """
                ${SONAR_SCANNER_HOME}/bin/sonar-scanner \
                  -Dsonar.projectKey=${SERVICE} \
                  -Dsonar.sources=. \
                  -Dsonar.host.url=http://sonarqube-dind:9000 \
                  -Dsonar.java.binaries=target/classes \
                  -Dsonar.token=$SONAR_TOKEN
              """
            }
          }
        }
      }
    }

    // 3) Trivy Source Scan
    stage('Trivy Source Scan') {
      steps {
        echo "üß© Escaneando dependencias con Trivy..."
        dir(env.SERVICE) {
          sh """
            trivy fs . \
              --format table \
              --severity HIGH,CRITICAL \
              -o trivy-fs-report.txt || true
          """
        }
      }
    }

    // 4) Docker Build
    stage('Build Docker Image') {
      steps {
        dir(env.SERVICE) {
          echo "üê≥ Construyendo imagen Docker..."
          sh "docker build -t ${IMAGE} ."
        }
      }
    }

    // 5) Ejecutar localmente en Docker
    stage('Run Local in Docker') {
      steps {
        echo "üß© Iniciando ${SERVICE} en red local (${NET}) para pruebas internas..."
        sh """
          # Crear red si no existe
          docker network inspect ${NET} >/dev/null 2>&1 || docker network create ${NET}

          # Detener y eliminar contenedor previo si existe
          docker rm -f ${SERVICE} >/dev/null 2>&1 || true

          # Ejecutar contenedor en red local
          docker run -d \
            --name ${SERVICE} \
            --network ${NET} \
            -p ${HOST}:${PORT} \
            -e SPRING_PROFILES_ACTIVE=dev \
            -e SERVER_PORT=${PORT} \
            ${IMAGE}

          echo "‚úÖ ${SERVICE} levantado localmente en http://localhost:${HOST}"
        """
      }
    }

    // 6) Trivy Image Scan
    stage('Trivy Image Scan') {
      steps {
        echo "üîé Escaneando imagen Docker..."
        sh """
          trivy image ${IMAGE} \
            --format table \
            --severity HIGH,CRITICAL \
            -o trivy-image-report.txt || true
        """
      }
    }

    // 7) Push to Artifact Registry
    stage('Push to Artifact Registry') {
      steps {
        echo "‚òÅÔ∏è Autenticando en GCP y empujando imagen..."
        withCredentials([file(credentialsId: 'gcp-credentials', variable: 'gcpCred')]) {
          withEnv(["GOOGLE_APPLICATION_CREDENTIALS=$gcpCred"]) {
            sh """
              gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
              gcloud config set project "$GCP_PROJECT_ID"
              gcloud auth configure-docker "$AR_HOST" --quiet

              if ! gcloud artifacts repositories describe "$REPOSITORY" --location="$REGION" --project="$GCP_PROJECT_ID" >/dev/null 2>&1 ; then
                gcloud artifacts repositories create "$REPOSITORY" \
                  --repository-format=docker \
                  --location="$REGION" \
                  --description="Docker repo for $SERVICE" \
                  --project="$GCP_PROJECT_ID"
              fi

              docker tag "$IMAGE" "$FULL_IMAGE_NAME"
              docker push "$FULL_IMAGE_NAME"
            """
          }
        }
      }
    }

    // 8) Deploy to Cloud Run
    stage('Deploy to Cloud Run') {
      steps {
        echo "üöÄ Desplegando ${SERVICE} en Cloud Run..."
        withCredentials([file(credentialsId: 'gcp-credentials', variable: 'gcpCred')]) {
          withEnv(["GOOGLE_APPLICATION_CREDENTIALS=$gcpCred"]) {
            sh """
              gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
              gcloud config set project "$GCP_PROJECT_ID"

              gcloud run deploy "$CR_SERVICE" \
                --image="$FULL_IMAGE_NAME" \
                --region="$REGION" \
                --platform="$CR_PLATFORM" \
                --port="$CR_PORT" \
                --memory="$CR_MEMORY" \
                --cpu="$CR_CPU" \
                --concurrency="$CR_CONCURRENCY" \
                --min-instances="$CR_MIN_INST" \
                --max-instances="$CR_MAX_INST" \
                --allow-unauthenticated \
                --quiet
            """
          }
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Build, an√°lisis, despliegue local y despliegue en GCP completados con √©xito para ${SERVICE}!"
    }
    failure {
      echo "‚ùå Fall√≥ el pipeline de ${SERVICE}!"
    }
    always {
      echo "=========================================="
      echo "Service: ${SERVICE}"
      echo "Status: ${currentBuild.result ?: 'SUCCESS'}"
      echo "Duration: ${currentBuild.durationString}"
      echo "=========================================="
      archiveArtifacts artifacts: "${SERVICE}/target/*.jar", allowEmptyArchive: true, fingerprint: true
      archiveArtifacts artifacts: "**/trivy-*.txt", allowEmptyArchive: true
    }
  }
}
