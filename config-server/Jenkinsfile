pipeline { 
    agent any

    tools {
        jdk 'java17016'
        maven 'maven399'
    }

    environment {
        SERVICE = 'config-server'
        IMAGE   = "farmatodo/${SERVICE}:latest"
        PORT    = '8888'
        HOST    = '8889'
        NET     = 'farmatodo-network'
    }

    stages {
        stage('Build') {
            steps {
                echo "üì¶ Clonando repositorio desde GitHub..."
                checkout scmGit(
                    branches: [[name: '*/main']],
                    extensions: [],
                    userRemoteConfigs: [[
                        credentialsId: 'jenkins-gcp',
                        url: 'https://github.com/santgodev/farmatodo-backend.git'
                    ]]
                )

                dir(SERVICE) {
                    echo "üß± Building and packaging ${SERVICE}..."
                    sh 'mvn clean package -DskipTests=false'
                    sh "docker build -t ${IMAGE} ."
                }
            }
        }

        stage('Deploy') {
            steps {
                echo "üöÄ Deploying ${SERVICE}..."
                sh """
                    docker network inspect ${NET} >/dev/null 2>&1 || docker network create ${NET}
                    docker rm -f ${SERVICE} >/dev/null 2>&1 || true
                    docker run -d --name ${SERVICE} -p ${HOST}:${PORT} --network ${NET} ${IMAGE}
                """
                echo "‚úÖ ${SERVICE} deployed successfully!"
                sh "docker ps --filter name=${SERVICE}"
            }
        }
    }

    post {
        success {
            echo "‚úÖ Build and deploy completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed!"
        }
    }
}
