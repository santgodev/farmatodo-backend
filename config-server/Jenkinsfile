pipeline {
    agent any

    tools {
        jdk 'java17016'
        maven 'maven399'
    }

    environment {
        SERVICE = 'config-server'
        IMAGE   = "farmatodo/${SERVICE}:latest"
        PORT    = '8888'
        HOST    = '8889'
        NET     = 'farmatodo-network'
    }

    stages {
        stage('Build') {
            steps {
                checkout scm
                dir(SERVICE) {
                    sh 'mvn clean package -DskipTests=false'
                    sh "docker build -t ${IMAGE} ."
                }
            }
        }

        stage('Deploy') {
            steps {
                sh """
                    docker network inspect ${NET} >/dev/null 2>&1 || docker network create ${NET}
                    docker rm -f ${SERVICE} >/dev/null 2>&1 || true
                    docker run -d --name ${SERVICE} -p ${HOST}:${PORT} --network ${NET} ${IMAGE}
                    echo "⏳ Checking health..."
                    for i in \$(seq 1 20); do
                        if curl -sf http://localhost:${HOST}/actuator/health >/dev/null; then
                            echo "✅ ${SERVICE} UP!"
                            exit 0
                        fi
                        sleep 5
                    done
                    echo "❌ ${SERVICE} not healthy"
                    docker logs ${SERVICE} | tail -n 15
                    exit 1
                """
            }
        }
    }

    post {
        success { echo "✅ Build & deploy OK!" }
        failure { echo "❌ Pipeline failed!" }
    }
}
